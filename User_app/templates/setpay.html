{% extends 'base-personal.html' %}
{% block personal_content %}
{% load static %}
<link href="{% static 'css/consumer/stepstyle.css' %}" rel="stylesheet" type="text/css">
					<div class="am-cf am-padding">
						<div class="am-fl am-cf"><strong class="am-text-danger am-text-lg">支付密码</strong> / <small>Set&nbsp;Pay&nbsp;Password</small></div>
					</div>
					<hr/>
					<!--进度条-->
					<div class="m-progress">
						<div class="m-progress-list">
							<span class="step-1 step">
                                <em class="u-progress-stage-bg"></em>
                                <i class="u-stage-icon-inner">1<em class="bg"></em></i>
                                <p class="stage-name">设置支付密码</p>
                            </span>
							<span class="step-2 step">
                                <em class="u-progress-stage-bg"></em>
                                <i class="u-stage-icon-inner">2<em class="bg"></em></i>
                                <p class="stage-name">完成</p>
                            </span>
							<span class="u-progress-placeholder"></span>
						</div>
						<div class="u-progress-bar total-steps-2">
							<div class="u-progress-bar-inner"></div>
						</div>
					</div>
					<form class="am-form am-form-horizontal" data-am-validator>
						<div class="am-form-group bind">
							<label for="user-phone" class="am-form-label">验证手机</label>
							<div class="am-form-content">
								<span id="user-phone">{{phone_pre}}XXXX{{phone_suffix}}</span>
							</div>
						</div>
						<div class="am-form-group code">
							<label for="user-code" class="am-form-label">验证码</label>
							<div class="am-form-content">
								<input type="text" id="user-code" placeholder="短信验证码" required maxlength="6" minlength="6">
							</div>
							<a class="btn" href="javascript:void(0);">
								<div class="am-btn am-btn-danger send_code" data-method="sendMobileCode" id="sendMobileCode">验证码</div>
							</a>
						</div>
						<div class="am-form-group">
							<label for="user-password" class="am-form-label">支付密码</label>
							<div class="am-form-content">
								<input type="password" id="user-password" placeholder="6位数字" required maxlength="6" minlength="6">
							</div>
						</div>
						<div class="am-form-group">
							<label for="user-confirm-password" class="am-form-label">确认密码</label>
							<div class="am-form-content">
								<input type="password" id="user-confirm-password" placeholder="请再次输入上面的密码" required maxlength="6" minlength="6">
							</div>
						</div>
						<div class="info-btn">
							<div class="am-btn am-btn-danger" data-method="save_pay" id="save_pay">保存修改</div>
						</div>
					</form>
{% endblock %}

{% block scriptContent %}
		sendMobileCode:function () {
			layer.load(0,{time:10000});
			let code = $("#user-phone").val();
			let data = {'way':'phone','phone':{{phone}}};
			let url = '/consumer/Verification-code-pay-chs-api/';
            var curCount1 = count;
            $(".send_code").attr("disabled", "true");
            $(".send_code").addClass("verify_ing");
            $(".send_code").val(+curCount1 + "秒再获取");
            InterValObj1 = window.setInterval(SetRemainTime1, 1000); //启动计时器，1秒执行一次
			$.ajax({
				type:'POST',
				url:url,
				data:data,
				headers:headers,
				success:function (data) {
					if(data.code === 41){
						layer.msg('短信发送成功',{icon:1,time:1000,closeBtn:0});
					}
					else if(data.code === 500){
						layer.msg('网络不佳',{icon:2,time:1200,closeBtn:0});
					}
				},
				error:function () {
					layer.msg('服务器无响应',{icon:2,time:1200,closeBtn:0});
				}
			});
            curCount1 = count;
            $(".send_code").attr("disabled", "true");
            $(".send_code").addClass("verify_ing");
            $(".send_code").text(+curCount1 + "秒再获取");
            InterValObj1 = window.setInterval(SetRemainTime1, 1000); //启动计时器，1秒执行一次
			layer.closeAll('loading');
			},
		save_pay:function () {
			let code = $("#user-code").val();
			let phone = $("#user-phone").text();
			let password = $("#user-password").val();
			let password_confirm = $("#user-confirm-password").val();
			if (code === '' || password === '' || password_confirm === ''){
				layer.msg('请填写完整的信息！',{icon:7,time:1200,closeBtn:0});
			}
			else if(password_confirm !== password){
				layer.msg('两次支付密码必须相同!',{icon:7, time:1200,closeBtn:0});
			}
			else{
                layer.load(0,{time:10000});
                let url = '/consumer/password-pay-chsc-api/';
			    let data = {'phone':phone,'code':code,'password':password};
				$.ajax({
				type:'POST',
				url:url,
				data:data,
				headers:headers,
				success:function (data) {
					if(data.code === 888){
						layer.msg('设置支付密码成功',{icon:1,time:1000,closeBtn:0});
                        $(".step-2").children().children().css({"opacity":1});
					}
					else if(data.code === -2222){
						layer.msg('验证码错误！',{icon:2, time:1200,closeBtn:0});
					}
					else if(data.code === 500){
						layer.msg('服务器无响应',{icon:2,time:1200,closeBtn:0});
					}
				},
				error:function () {
					layer.msg('服务器无响应',{icon:2,time:1200,closeBtn:0});
				}
			});
			}
			layer.closeAll('loading');
			$("#user-code").val('');
			$("#user-password").val('');
			$("#user-confirm-password").val('');
		},
{% endblock %}